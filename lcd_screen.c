#include <stdint.h>
    #include <stdbool.h>
    #include "inc/hw_memmap.h"
    #include "driverlib/fpu.h"
    #include "driverlib/sysctl.h"
    #include "driverlib/rom.h"
    #include "driverlib/pin_map.h"
    #include "driverlib/uart.h"
    #include "grlib/grlib.h"
    #include "drivers/ili9341_240x320x262K.h"
    #include "utils/uartstdio.h"
    #include "driverlib/gpio.h"

    #define GPIO_PINS_ALL GPIO_PIN_0|GPIO_PIN_1|GPIO_PIN_2|GPIO_PIN_3|GPIO_PIN_4|GPIO_PIN_5|GPIO_PIN_6|GPIO_PIN_7

    const uint8_t circle_empty[] =
    {
        IMAGE_FMT_4BPP_COMP,
        32, 0,
        32, 0,

        2,
        0x00, 0x00, 0x00,
        0xbc, 0xbc, 0xbc,
        0xff, 0xff, 0xff,

        0x1c, 0x22, 0x22, 0x22, 0xe9, 0xb7, 0x8b, 0x20, 0x00, 0x02, 0x11, 0x11,
        0x11, 0x11, 0x00, 0x02, 0x76, 0x01, 0x8e, 0x8a, 0x11, 0x11, 0x10, 0x05,
        0x13, 0x6a, 0x00, 0xa2, 0x03, 0x20, 0x8e, 0x11, 0x11, 0x02, 0x02, 0x01,
        0x9b, 0x87, 0x11, 0x10, 0x0f, 0x65, 0x02, 0x87, 0x87, 0x6f, 0x01, 0x07,
        0x01, 0x10, 0x0f, 0x87, 0x87, 0x3b, 0x6d, 0x02, 0x87, 0x85, 0x01, 0x07,
        0x03, 0x10, 0x87, 0xff, 0x87, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
        0xf6, 0x07, 0x07, 0x07, 0x02, 0x20, 0x07, 0x03, 0x02, 0xf3, 0x87, 0x87,
        0x07, 0x03, 0x22, 0x01, 0x07, 0x01, 0x0f, 0x10, 0x22, 0x22, 0x20, 0x0f,
        0x0b, 0x87, 0x86, 0x24, 0x22, 0x01, 0x07, 0x11, 0x10, 0x89, 0x22, 0x20,
        0xc5, 0x0f, 0x0b, 0x22, 0x22, 0x00, 0x06, 0x00, 0x8b, 0x14, 0x22, 0x22,
        0x01, 0x04, 0x10, 0x8d, 0x22, 0x20, 0x50, 0x00, 0x13, 0x02, 0x86, 0x22,
        0x22, 0x00, 0x00, 0x20, 0x00, 0x00, 0x14,
    };
    const uint8_t circle_green[] =
    {
        IMAGE_FMT_4BPP_COMP,
        32, 0,
        32, 0,

        2,
        0x00, 0x00, 0x00,
        0x00, 0xff, 0x06,
        0xff, 0xff, 0xff,

        0x1c, 0x22, 0x22, 0x22, 0xe9, 0xb7, 0x8b, 0x20, 0x00, 0x02, 0x11, 0x11,
        0x11, 0x11, 0x00, 0x02, 0x76, 0x01, 0x8e, 0x8a, 0x11, 0x11, 0x10, 0x05,
        0x13, 0x6a, 0x00, 0xa2, 0x03, 0x20, 0x8e, 0x11, 0x11, 0x02, 0x02, 0x01,
        0x9b, 0x87, 0x11, 0x10, 0x0f, 0x65, 0x02, 0x87, 0x87, 0x6f, 0x01, 0x07,
        0x01, 0x10, 0x0f, 0x87, 0x87, 0x3b, 0x6d, 0x02, 0x87, 0x85, 0x01, 0x07,
        0x03, 0x10, 0x87, 0xff, 0x87, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
        0xf6, 0x07, 0x07, 0x07, 0x02, 0x20, 0x07, 0x03, 0x02, 0xf3, 0x87, 0x87,
        0x07, 0x03, 0x22, 0x01, 0x07, 0x01, 0x0f, 0x10, 0x22, 0x22, 0x20, 0x0f,
        0x0b, 0x87, 0x86, 0x24, 0x22, 0x01, 0x07, 0x11, 0x10, 0x89, 0x22, 0x20,
        0xc5, 0x0f, 0x0b, 0x22, 0x22, 0x00, 0x06, 0x00, 0x8b, 0x14, 0x22, 0x22,
        0x01, 0x04, 0x10, 0x8d, 0x22, 0x20, 0x50, 0x00, 0x13, 0x02, 0x86, 0x22,
        0x22, 0x00, 0x00, 0x20, 0x00, 0x00, 0xb5,
    };
    const uint8_t circle_blue[] =
    {
        IMAGE_FMT_4BPP_COMP,
        32, 0,
        32, 0,

        2,
        0x00, 0x00, 0x00,
        0xff, 0x90, 0x00,
        0xff, 0xff, 0xff,

        0x1c, 0x22, 0x22, 0x22, 0xe9, 0xb7, 0x8b, 0x20, 0x00, 0x02, 0x11, 0x11,
        0x11, 0x11, 0x00, 0x02, 0x76, 0x01, 0x8e, 0x8a, 0x11, 0x11, 0x10, 0x05,
        0x13, 0x6a, 0x00, 0xa2, 0x03, 0x20, 0x8e, 0x11, 0x11, 0x02, 0x02, 0x01,
        0x9b, 0x87, 0x11, 0x10, 0x0f, 0x65, 0x02, 0x87, 0x87, 0x6f, 0x01, 0x07,
        0x01, 0x10, 0x0f, 0x87, 0x87, 0x3b, 0x6d, 0x02, 0x87, 0x85, 0x01, 0x07,
        0x03, 0x10, 0x87, 0xff, 0x87, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
        0xf6, 0x07, 0x07, 0x07, 0x02, 0x20, 0x07, 0x03, 0x02, 0xf3, 0x87, 0x87,
        0x07, 0x03, 0x22, 0x01, 0x07, 0x01, 0x0f, 0x10, 0x22, 0x22, 0x20, 0x0f,
        0x0b, 0x87, 0x86, 0x24, 0x22, 0x01, 0x07, 0x11, 0x10, 0x89, 0x22, 0x20,
        0xc5, 0x0f, 0x0b, 0x22, 0x22, 0x00, 0x06, 0x00, 0x8b, 0x14, 0x22, 0x22,
        0x01, 0x04, 0x10, 0x8d, 0x22, 0x20, 0x50, 0x00, 0x13, 0x02, 0x86, 0x22,
        0x22, 0x00, 0x00, 0x20, 0x00, 0x00, 0x14,
    };

void drawCircles(tContext sContext, int axis[2])
{
    switch(axis[0])
    {
    case -2:
        GrImageDraw(&sContext, circle_green, 144, 188);
        break;
    case -1:
        GrImageDraw(&sContext, circle_blue, 144, 148);
        GrImageDraw(&sContext, circle_empty, 144, 188);
        break;
    case 0:
        GrImageDraw(&sContext, circle_empty, 144, 60);
        GrImageDraw(&sContext, circle_empty, 144, 20);
        GrImageDraw(&sContext, circle_empty, 144, 148);
        GrImageDraw(&sContext, circle_empty, 144, 188);
        break;
    case 1:
        GrImageDraw(&sContext, circle_blue, 144, 60);
        GrImageDraw(&sContext, circle_empty, 144, 20);
        break;
    default:
        GrImageDraw(&sContext, circle_green, 144, 20);
        break;
    }
    switch(axis[1])
    {
    case -2:
        GrImageDraw(&sContext, circle_green, 60, 104);
        break;
    case -1:
        GrImageDraw(&sContext, circle_blue, 100, 104);
        GrImageDraw(&sContext, circle_empty, 60, 104);
        break;
    case 0:
        GrImageDraw(&sContext, circle_empty, 100, 104);
        GrImageDraw(&sContext, circle_empty, 60, 104);
        GrImageDraw(&sContext, circle_empty, 188, 104);
        GrImageDraw(&sContext, circle_empty, 228, 104);
        break;
    case 1:
        GrImageDraw(&sContext, circle_blue, 188, 104);
        GrImageDraw(&sContext, circle_empty, 228, 104);
        break;
    default:
        GrImageDraw(&sContext, circle_green, 228, 104);
        break;
    }
}

int main(void)
    {
    tContext sContext;
    tRectangle sRect;

    SysCtlPeripheralEnable (SYSCTL_PERIPH_GPIOB);
    SysCtlPeripheralEnable (SYSCTL_PERIPH_GPIOE);
    SysCtlPeripheralEnable (SYSCTL_PERIPH_GPIOH);
    SysCtlPeripheralEnable (SYSCTL_PERIPH_GPIOK);
    GPIOPinTypeGPIOInput(GPIO_PORTB_BASE, GPIO_PINS_ALL);
    GPIOPinTypeGPIOInput(GPIO_PORTK_BASE, GPIO_PINS_ALL);
    GPIOPinTypeGPIOInput(GPIO_PORTE_BASE, GPIO_PINS_ALL);
    GPIOPinTypeGPIOInput(GPIO_PORTH_BASE, GPIO_PINS_ALL);

    ROM_FPULazyStackingEnable();

    ROM_SysCtlClockSet(SYSCTL_SYSDIV_4 | SYSCTL_USE_PLL | SYSCTL_XTAL_16MHZ | SYSCTL_OSC_MAIN);

    ILI9341_240x320x262K_Init();

    GrContextInit(&sContext, &g_sILI9341_240x320x262K);

    sRect.i16XMin = 140;
    sRect.i16YMin = 100;
    sRect.i16XMax = 180;
    sRect.i16YMax = 140;

    GrContextForegroundSet(&sContext, ClrRed);
    GrRectFill(&sContext, &sRect);
    GrContextForegroundSet(&sContext, ClrWhite);

    int up = 0;
    int down = 0;
    int left = 0;
    int right = 0;
    int axis[2] = {0, 0};

    drawCircles(sContext, axis);

    while(true)
    {
        up = GPIOPinRead(GPIO_PORTB_BASE,GPIO_PIN_0);
        down = GPIOPinRead(GPIO_PORTE_BASE,GPIO_PIN_5);
        left = GPIOPinRead(GPIO_PORTK_BASE,GPIO_PIN_7);
        right = GPIOPinRead(GPIO_PORTE_BASE,GPIO_PIN_4);
        if (up == 0 && axis[0] < 2)
        {
             axis[0]+=1;
             drawCircles(sContext, axis);
             SysCtlDelay(SysCtlClockGet() / 35);
        }
        if (down == 0 && axis[0] > -2)
        {
             axis[0]-=1;
             drawCircles(sContext, axis);
             SysCtlDelay(SysCtlClockGet() / 35);
        }
        if (right != 0 && axis[1] < 2)
        {
             axis[1]+=1;
             drawCircles(sContext, axis);
             SysCtlDelay(SysCtlClockGet() / 35);
        }
        if (left == 0 && axis[1] > -2)
        {
             axis[1]-=1;
             drawCircles(sContext, axis);
             SysCtlDelay(SysCtlClockGet() / 35);
        }
    }
}
